<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Ophthalmoscope Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #4b5563;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="app" class="h-screen flex">
        <div class="w-80 bg-gray-800 p-4 border-r border-gray-700 overflow-y-auto">
            <div class="flex items-center gap-2 mb-6">
                <svg class="text-blue-400" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <h1 class="text-xl font-bold text-white">Direct Ophthalmoscope</h1>
            </div>

            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <button id="powerBtn" class="w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v10M18.4 6.6a9 9 0 1 1-12.77.04"/>
                    </svg>
                    <span>POWER OFF</span>
                </button>
            </div>

            <div class="mb-4">
                <label class="text-white text-sm font-semibold mb-2 block">
                    Distance from Eye: <span id="distanceValue">3.0</span> cm
                </label>
                <input type="range" id="distance" min="1" max="12" step="0.5" value="3" class="w-full">
                <div class="text-xs text-gray-400 mt-1" id="distanceHint">Optimal distance</div>
            </div>

            <div class="mb-4">
                <label class="text-white text-sm font-semibold mb-2 block">
                    Diopter Wheel: <span id="diopterValue">0</span>D
                </label>
                <input type="range" id="diopter" min="-20" max="20" step="1" value="0" class="w-full">
                <div class="text-xs text-gray-400 mt-1">Compensate for refractive error & working distance</div>
            </div>

            <div class="mb-4">
                <label class="text-white text-sm font-semibold mb-2 flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                        <path d="M12 4v1M17.66 6.34l-.71.71M20 12h-1M17.66 17.66l-.71-.71M12 19v1M6.34 17.66l.71-.71M4 12h1M6.34 6.34l.71.71"/>
                    </svg>
                    Light Intensity: <span id="brightnessValue">80</span>%
                </label>
                <input type="range" id="brightness" min="30" max="120" step="5" value="80" class="w-full">
            </div>

            <div class="mb-4">
                <label class="text-white text-sm font-semibold mb-2 block">Aperture Selection</label>
                <div class="grid grid-cols-3 gap-2">
                    <button class="aperture-btn py-2 px-3 rounded text-sm font-medium transition bg-gray-600 text-gray-300 hover:bg-gray-500" data-aperture="small">Small</button>
                    <button class="aperture-btn py-2 px-3 rounded text-sm font-medium transition bg-blue-600 text-white" data-aperture="medium">Medium</button>
                    <button class="aperture-btn py-2 px-3 rounded text-sm font-medium transition bg-gray-600 text-gray-300 hover:bg-gray-500" data-aperture="large">Large</button>
                </div>
            </div>

            <div class="space-y-2 mb-4">
                <button id="effectsBtn" class="w-full px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 transition flex items-center justify-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                    <span>Realistic Effects: ON</span>
                </button>
                <button id="infoBtn" class="w-full px-3 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 transition flex items-center justify-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    Hide Info Overlay
                </button>
                <button id="resetBtn" class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                        <path d="M16 16h5v5"/>
                    </svg>
                    Reset View
                </button>
            </div>

            <div class="p-3 bg-gray-700 rounded-lg text-xs text-gray-300">
                <div id="statusMessage">Loading image library from GitHub...</div>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center bg-black p-8">
            <canvas id="canvas" width="600" height="600" class="border-4 border-gray-700 rounded-lg cursor-default"></canvas>
            <div class="mt-4 text-gray-400 text-sm text-center max-w-md" id="statusText">
                Turn on the ophthalmoscope to begin examination
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const GITHUB_USER = 'csbrown4';
        const GITHUB_REPO = 'opthosim';
        const GITHUB_BRANCH = 'main';
        const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}`;
        
        // Global state
        let imageLibrary = {};
        let state = {
            isOn: false,
            currentImageIndex: 0,
            currentCondition: 'normal',
            aperture: 'medium',
            diopter: 0,
            brightness: 80,
            distance: 3,
            viewAngle: { x: 0, y: 0 },
            showInfo: true,
            realisticEffects: true,
            isDragging: false,
            lastMouse: { x: 0, y: 0 },
            loadedImages: {},
            imageErrors: {},
            time: 0,
            blinkTimer: 0,
            isLoading: true
        };

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const apertureSettings = {
            small: { size: 80 },
            medium: { size: 120 },
            large: { size: 180 }
        };

        // Initialize - load images from GitHub
        async function init() {
            try {
                document.getElementById('statusMessage').textContent = 'Loading from GitHub...';
                
                const resp = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents`);
                const folders = (await resp.json()).filter(i => i.type === 'dir');
                
                for (const folder of folders) {
                    const fr = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${folder.name}`);
                    const files = (await fr.json()).filter(f => /\.(jpe?g|png)$/i.test(f.name));
                    
                    if (files.length > 0) {
                        imageLibrary[folder.name] = {
                            name: folder.name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            images: files.map(f => `${RAW_BASE}/${folder.name}/${f.name}`)
                        };
                    }
                }
                
                const conditions = Object.keys(imageLibrary);
                if (conditions.length > 0) {
                    state.currentCondition = conditions[0];
                    document.getElementById('statusMessage').textContent = `Loaded ${conditions.length} conditions!`;
                } else {
                    throw new Error('No images found');
                }
            } catch (err) {
                console.error('GitHub load failed:', err);
                // Fallback
                imageLibrary = {
                    normal: {
                        name: 'Normal',
                        images: Array.from({length: 10}, (_, i) => 
                            `${RAW_BASE}/normal/1ffa96${String(44+i).padStart(2,'0')}-8d87-11e8-9daf-6045cb817f5b..JPG`
                        ).filter((_, i) => ![2,3,5,6,8,9].includes(i))
                    }
                };
                state.currentCondition = 'normal';
                document.getElementById('statusMessage').textContent = 'Using default images';
            }
            
            state.isLoading = false;
            loadCurrentImage();
        }

        function loadCurrentImage() {
            if (!imageLibrary[state.currentCondition]) return;
            const imgs = imageLibrary[state.currentCondition].images;
            if (!imgs || imgs.length === 0) return;
            
            const url = imgs[state.currentImageIndex];
            if (state.loadedImages[url] || state.imageErrors[url]) {
                draw();
                return;
            }

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                state.loadedImages[url] = img;
                draw();
            };
            img.onerror = () => {
                state.imageErrors[url] = true;
                draw();
            };
            img.src = url;
        }

        function calculateFOV() {
            const base = apertureSettings[state.aperture].size;
            const d = state.distance;
            if (d < 1.5) return base * 0.3;
            if (d < 3) return base * (0.5 + (d - 1.5) * 0.4);
            if (d <= 6) return base * (1.1 + (d - 3) * 0.1);
            if (d <= 8) return base * (1.4 - (d - 6) * 0.2);
            return base * 0.8;
        }

        function calculateFocus() {
            const workingDist = 2.5;
            const distDiff = state.distance - workingDist;
            const neededDiopter = -distDiff * 4;
            const focusError = Math.abs(state.diopter - neededDiopter);
            
            if (focusError < 3) return 1.0;
            if (focusError < 8) return 1.0 - (focusError - 3) / 10;
            return Math.max(0.3, 1.0 - focusError / 20);
        }

        function draw() {
            const w = canvas.width, h = canvas.height;
            const cx = w/2, cy = h/2;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            
            if (!state.isOn) {
                ctx.fillStyle = '#666';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Ophthalmoscope OFF', cx, cy);
                return;
            }

            if (state.realisticEffects) {
                state.time += 0.016;
                if (Math.random() < 0.004) state.blinkTimer = 0.15;
                if (state.blinkTimer > 0) state.blinkTimer -= 0.016;
            }

            const fov = calculateFOV();
            const focus = calculateFocus();

            if (state.distance > 8) {
                const pupil = Math.min(fov * 0.8, 100);
                const g1 = ctx.createRadialGradient(cx, cy, pupil * 0.7, cx, cy, pupil);
                g1.addColorStop(0, 'rgba(255, 100, 60, 0.9)');
                g1.addColorStop(0.8, 'rgba(220, 50, 30, 0.7)');
                g1.addColorStop(1, 'rgba(0, 0, 0, 1)');
                ctx.fillStyle = g1;
                ctx.beginPath();
                ctx.arc(cx, cy, pupil, 0, Math.PI * 2);
                ctx.fill();
                return;
            }

            if (!imageLibrary[state.currentCondition]) return;
            const imgs = imageLibrary[state.currentCondition].images;
            if (!imgs || imgs.length === 0) return;
            
            const url = imgs[state.currentImageIndex];
            const img = state.loadedImages[url];
            
            if (!img) {
                ctx.fillStyle = '#444';
                ctx.beginPath();
                ctx.arc(cx, cy, fov, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Loading...', cx, cy);
                return;
            }

            ctx.save();
            ctx.beginPath();
            ctx.arc(cx, cy, fov, 0, Math.PI * 2);
            ctx.clip();

            const blink = (state.realisticEffects && state.blinkTimer > 0) ? Math.min(state.blinkTimer * 5, 0.85) : 0;
            const bright = (state.brightness / 80) * (1 - blink);
            const blur = focus < 0.9 ? Math.floor((1 - focus) * 8) : 0;
            ctx.filter = blur > 0 ? `brightness(${bright}) blur(${blur}px)` : `brightness(${bright})`;

            const scale = 0.6;
            const iw = img.width * scale, ih = img.height * scale;
            const ox = cx - iw/2 - state.viewAngle.x;
            const oy = cy - ih/2 - state.viewAngle.y;
            
            ctx.drawImage(img, ox, oy, iw, ih);
            ctx.filter = 'none';
            ctx.restore();

            // Vignetting
            const vig = ctx.createRadialGradient(cx, cy, fov * 0.6, cx, cy, fov);
            vig.addColorStop(0, 'rgba(0,0,0,0)');
            vig.addColorStop(0.7, 'rgba(0,0,0,0.3)');
            vig.addColorStop(0.9, 'rgba(0,0,0,0.8)');
            vig.addColorStop(1, 'rgba(0,0,0,1)');
            ctx.save();
            ctx.beginPath();
            ctx.arc(cx, cy, fov, 0, Math.PI * 2);
            ctx.clip();
            ctx.fillStyle = vig;
            ctx.fillRect(0,0,w,h);
            ctx.restore();

            if (state.showInfo) {
                ctx.fillStyle = 'rgba(0,0,0,0.8)';
                ctx.fillRect(10, 10, 250, 110);
                ctx.fillStyle = '#fff';
                ctx.font = '14px monospace';
                ctx.textAlign = 'left';
                ctx.fillText(`Focus: ${focus < 0.7 ? 'Poor' : focus < 0.9 ? 'Fair' : 'Sharp'}`, 20, 30);
                ctx.fillText(`Distance: ${state.distance.toFixed(1)} cm`, 20, 50);
                ctx.fillText(`Diopter: ${state.diopter > 0 ? '+' : ''}${state.diopter}D`, 20, 70);
                ctx.fillText(`Pan: X=${state.viewAngle.x.toFixed(0)} Y=${state.viewAngle.y.toFixed(0)}`, 20, 90);
                ctx.fillText(`Condition: ${imageLibrary[state.currentCondition].name}`, 20, 110);
            }

            if (focus < 0.7) {
                ctx.fillStyle = 'rgba(200, 50, 50, 0.9)';
                ctx.fillRect(w/2 - 120, h - 50, 240, 35);
                ctx.fillStyle = '#fff';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Adjust diopter wheel for sharp focus', cx, h - 32);
            }
        }

        // Event handlers
        document.getElementById('powerBtn').addEventListener('click', () => {
            state.isOn = !state.isOn;
            const btn = document.getElementById('powerBtn');
            btn.className = `w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 ${state.isOn ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white`;
            btn.querySelector('span').textContent = state.isOn ? 'POWER ON' : 'POWER OFF';
            canvas.style.cursor = state.isOn && state.distance <= 8 ? 'move' : 'default';
            draw();
        });

        document.getElementById('distance').addEventListener('input', (e) => {
            state.distance = parseFloat(e.target.value);
            document.getElementById('distanceValue').textContent = state.distance.toFixed(1);
            const hint = state.distance > 8 ? 'Too far - red reflex only' : 
                        state.distance < 1.5 ? 'Too close - very limited view' : 
                        state.distance >= 2 && state.distance <= 5 ? 'Optimal distance' : 'Good distance';
            document.getElementById('distanceHint').textContent = hint;
            canvas.style.cursor = state.isOn && state.distance <= 8 ? 'move' : 'default';
            draw();
        });

        document.getElementById('diopter').addEventListener('input', (e) => {
            state.diopter = parseInt(e.target.value);
            document.getElementById('diopterValue').textContent = `${state.diopter > 0 ? '+' : ''}${state.diopter}`;
            draw();
        });

        document.getElementById('brightness').addEventListener('input', (e) => {
            state.brightness = parseInt(e.target.value);
            document.getElementById('brightnessValue').textContent = state.brightness;
            draw();
        });

        document.querySelectorAll('.aperture-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!state.isOn) return;
                state.aperture = btn.dataset.aperture;
                document.querySelectorAll('.aperture-btn').forEach(b => {
                    b.className = 'aperture-btn py-2 px-3 rounded text-sm font-medium transition bg-gray-600 text-gray-300 hover:bg-gray-500';
                });
                btn.className = 'aperture-btn py-2 px-3 rounded text-sm font-medium transition bg-blue-600 text-white';
                draw();
            });
        });

        document.getElementById('effectsBtn').addEventListener('click', () => {
            state.realisticEffects = !state.realisticEffects;
            document.querySelector('#effectsBtn span').textContent = `Realistic Effects: ${state.realisticEffects ? 'ON' : 'OFF'}`;
            if (!state.realisticEffects) {
                state.time = 0;
                state.blinkTimer = 0;
                draw();
            }
        });

        document.getElementById('infoBtn').addEventListener('click', () => {
            state.showInfo = !state.showInfo;
            document.getElementById('infoBtn').innerHTML = document.getElementById('infoBtn').innerHTML.replace(state.showInfo ? 'Show' : 'Hide', state.showInfo ? 'Hide' : 'Show');
            draw();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            state.viewAngle = { x: 0, y: 0 };
            state.diopter = 0;
            state.distance = 3;
            state.brightness = 80;
            state.aperture = 'medium';
            document.getElementById('distance').value = 3;
            document.getElementById('diopter').value = 0;
            document.getElementById('brightness').value = 80;
            document.getElementById('distanceValue').textContent = '3.0';
            document.getElementById('diopterValue').textContent = '0';
            document.getElementById('brightnessValue').textContent = '80';
            document.getElementById('distanceHint').textContent = 'Optimal distance';
            document.querySelectorAll('.aperture-btn').forEach(b => {
                b.className = b.dataset.aperture === 'medium' ? 
                    'aperture-btn py-2 px-3 rounded text-sm font-medium transition bg-blue-600 text-white' :
                    'aperture-btn py-2 px-3 rounded text-sm font-medium transition bg-gray-600 text-gray-300 hover:bg-gray-500';
            });
            draw();
        });

        canvas.addEventListener('mousedown', (e) => {
            if (!state.isOn || state.distance > 8) return;
            state.isDragging = true;
            const rect = canvas.getBoundingClientRect();
            state.lastMouse = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!state.isDragging) return;
            const rect = canvas.getBoundingClientRect();
            const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
            const dx = cx - state.lastMouse.x, dy = cy - state.lastMouse.y;
            state.viewAngle.x = Math.max(-450, Math.min(450, state.viewAngle.x + dx * 1.5));
            state.viewAngle.y = Math.max(-450, Math.min(450, state.viewAngle.y + dy * 1.5));
            state.lastMouse = { x: cx, y: cy };
            draw();
        });

        canvas.addEventListener('mouseup', () => state.isDragging = false);
        canvas.addEventListener('mouseleave', () => state.isDragging = false);

        function animate() {
            if (state.isOn && state.realisticEffects) draw();
            requestAnimationFrame(animate);
        }

        // Start
        init();
        draw();
        animate();
    </script>
</body>
</html>
